## 2026-01-06
2つのプロジェクトを作成する

```bash
quarkus create app inuverse:consumer-a \
    --extension='kotlin' \
    --gradle-kotlin-dsl
```

```bash
quarkus create app inuverse:consumer-b \
    --extension='kotlin' \
    --gradle-kotlin-dsl
```

ちな、dslはdomain specific languageの略な

REST-APIに対応させたい。エントリーポイントがないので[JSON RESTサービスを実装](https://ja.quarkus.io/guides/rest-json)を参考にする

`Quarkus.run(*args)`が呼び出されると、Quarkusのブートストラッププロセスが開始する。
Quarkusの起動シーケンスは、
1. クラスパススキャン
2. CDI（Contexts and Dependency Injection）コンテナが構築
3. @ApplicationScoped、@Singleton、@Inject などのアノテーションが付いたクラスがインスタンス化 
4. 拡張機能（extensions）の初期化
5. Quarkus が組み込まれている拡張（例: quarkus-resteasy, quarkus-smallrye-reactive-messaging など）が起動 
6. @Observes StartupEvent がトリガー

Xxx.onStart が最初に呼び出されます（`StartupEvent`を受け取るメソッドはQuarkusが起動完了直後に実行）。

例えば下記のイメージ
```kotlin
@Inject
lateinit var config: XxxConfig
fun onStart(@Observes startupEvent: StartupEvent) {
    println("StartEvent")
}
```
StartupEvent, ShutdownEventを学ぶ
[アプリケーションの初期化と終了](https://ja.quarkus.io/guides/lifecycle)

## 2026-01-07
- RabbitMQを追加
- docker-compose.yamlを追加
- `docker-compose up --build -d`


1. ディレクトリ構造とDocker設定の不一致
* 問題: docker-compose.yamlがサンプルのままで、現在のプロジェクト（consumer-a, consumer-b）のパスや構成を認識できていない
* 解決: docker-compose.yamlを書き換え、現在のフォルダ構成とサービス名に合わせてビルド・起動できるように修正

2. RabbitMQの受信設定の不足
* 問題: consumer-aのプログラムコード（QuoteResource.kt）では処理結果を受信しようとしていたが、application.propertiesに「どのQueueから受信す
  るか」という定義が欠落
* 解決: consumer-aに受信チャネル（mp.messaging.incoming.quotes）の設定を追加

3. コンテナ間のネットワーク接続エラー（Connection Refused）
* 問題: アプリケーションがRabbitMQの接続先をデフォルトのlocalhostと誤認しており、コンテナ外のRabbitMQサービス（rabbit
  ホスト）を見つけられず、接続拒否が発生
* 解決:
    * application.propertiesで環境変数を介して接続先ホスト（rabbitmq-host）を動的に設定できるように修正。
    * docker-compose.yamlで環境変数RABBITMQ_HOST: rabbitを注入し、コンテナ間通信を確立させました。

4. ビルド・デプロイ環境の不整合
* 問題: 初期のビルドで
  Testcontainers（Dockerを用いたテスト）が動作せず、不整合なテストコードによってビルドが失敗
  止していました。
* 解決:
    * 現在は疎通確認を優先するため、不整合なテストをスキップ（-x test）してビルドを成功


```bash
docker-compose down
```

異なるポートでアプリを立ち上げる
consumer-a
```bash
./gradlew quarkusDev
```

consumer-b
```bash
 ./gradlew quarkusDev -Dquarkus.http.port=8081
```
```bash
docker-compose up -d rabbit
```

## 2025-01-08

Kotlinで `private val quotes: Multi<Quote>` とコンストラクタに書くと、コンパイラは内部的に以下の3つを生成する
1. コンストラクタの引数 (parameter)
2. クラスのフィールド (field)
3. 値を返すゲッター (getter)

よって`@Channel`というアノテーションがいまはデフォルトで1だけについているが、将来は2にも自動でつくようになる曖昧さがあるので
警告を出している。

解決策：`@param`をつける
するとコンストラクタは

```kotlin
@param:Channel("quote-requests")
private val quoteRequestEmitter: Emitter<String>
```

のようになる。